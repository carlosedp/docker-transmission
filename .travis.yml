sudo: required

services:
 - docker

language: bash

env:
  global:
    - IMAGE=carlosedp/arm-transmission
    - QEMU_VERSION=v2.9.1-1
  matrix:
    # TARGET = Base image architecture to be used
    # QEMU_ARCH = qemu binary to be downloaded from https://github.com/multiarch/qemu-user-static/releases
    # TAG = Tag to be applied to the image when upload to DockerHub
    - TARGET=amd64 QEMU_ARCH=amd64 TAG=amd64
    - TARGET=aarch64 QEMU_ARCH=aarch64 TAG=arm64
    - TARGET=arm32v6 QEMU_ARCH=arm TAG=arm

script:
  - ./travis-build.sh
  - >
    if [ "$TRAVIS_BRANCH" == "master" -a "$TRAVIS_PULL_REQUEST" == "false" ]; then
      # Push image
      docker login -u="$DOCKER_USER" -p="$DOCKER_PASS"
      docker push "$IMAGE":"$TAG"
    fi

jobs:
  include:
    - stage: deploy
      script:
        - echo "Downloading manifest-tool"
        - wget https://github.com/estesp/manifest-tool/releases/download/v0.7.0/manifest-tool-linux-amd64
        - mv manifest-tool-linux-amd64 manifest-tool
        - chmod +x manifest-tool
        - ./manifest-tool --version
        - echo "Pushing manifest "$IMAGE":latest"
        - >
          ./manifest-tool push from-args \
              --platforms linux/amd64,linux/arm,linux/arm64 \
              --template "$IMAGE:ARCH" \
              --target "$IMAGE:latest"
      env:
        TARGET=none QEMU_ARCH=none TAG=none
